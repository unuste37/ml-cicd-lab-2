# The name of the workflow as it appears in the GitHub Actions tab
name: SageMaker CI/CD Pipeline

on:
  # Trigger the workflow automatically when code is pushed to the 'main' branch
  push:
    branches:
      - main
  # Allows you to manually trigger this workflow from the GitHub UI Actions tab
  workflow_dispatch:

jobs:
  build-and-deploy:
    # Use the latest Ubuntu runner provided by GitHub
    runs-on: ubuntu-latest
    
    steps:
      # 1. Pull the code from your repository into the GitHub runner
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. Cleanup: GitHub runners have limited disk space (~14GB).
      # This step removes pre-installed software (Android, .NET, Haskell) 
      # to free up ~20GB of space for heavy ML libraries like SageMaker.
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      # 3. Setup Python environment. 
      # "3.10" is in quotes to prevent YAML from reading it as the number 3.1.
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # 4. Install ML libraries.
      # CRITICAL: We pin 'sagemaker<3.0.0' because v3.x is modular and 
      # would break 'sagemaker.workflow' imports in our current pipeline.py.
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install --no-cache-dir "sagemaker<3.0.0" boto3 pandas scikit-learn
          # Verification: A 'smoke test' to ensure the pipeline module is actually installed
          python -c "from sagemaker.workflow.pipeline import Pipeline; print('âœ… SageMaker Workflow module verified.')"

      # 5. Execute the pipeline script.
      # We map GitHub Secrets to Environment Variables so the script can authenticate with AWS.
      - name: Trigger SageMaker Pipeline
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: us-east-1
          # SageMaker Session objects specifically look for AWS_DEFAULT_REGION
          AWS_DEFAULT_REGION: us-east-1  
        run: |
          python pipeline.py

##end